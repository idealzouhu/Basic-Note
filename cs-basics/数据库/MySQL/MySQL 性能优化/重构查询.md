### 重构查询的方式



### 成本分析

网络通信、查询解析和优化都很轻量。在某些版本的MySQL中，即使在一台通用服务器上，也能够运行每秒超过10万次的简单查询，即使是一个千兆网卡也能轻松满足每秒超过2000次的查询。因此，运行多个小查询问题不大。

在MySQL内部，每秒能够扫描内存中上百万行的数据，相比之下，MySQL响应数据给客 户端就慢得多了。在其他条件都相同的时候，使用尽可能少的查询当然是更好的。

但是，有时候，**将一个大查询分解成多个小查询也是有必要的**。



### 切分查询

删除旧的数据就是一个很好的例子。定期清除大量数据时，如果用一个大的语句一次性完成的话，则可能需要一次**锁住很多数据**、占满整个事务日志、耗尽系统资源、阻塞很多小 的但重要的查询。将一个大的DELETE语句切分成多个较小的查询可以尽可能小地影响 MySQL 的性能，同时还可以降低 MySQL 复制的延迟。





### 分解联接查询

很多高性能的应用都会对联接查询进行分解。简单地说，可以**对每一个表进行一次单表查 询，然后将结果在应用程序中进行联接**。

用分解联接查询的方式重构查询有如下优势：

- 让缓存的效率更高。许多应用程序可以方便地缓存单表查询对应的结果对象。例 如，上面查询中的tag mysql已经被缓存了，那么应用就可以跳过第一个查询。再例 如，应用中已经缓存了ID为123、567、9098的内容，那么第三个查询的IN()中就可 以少几个ID。
- 将查询分解后，执行单个查询可以减少锁的竞争。
- 在应用层做联接，可以更容易对数据库进行拆分，更容易做到高性能和可扩展。
-  可以减少对冗余记录的访问。在应用层做联接查询，意味着对于某条记录应用只需 要查询一次，而在数据库中做联接查询，则可能需要重复地访问一部分数据。从这 点看，这样的重构还可能会减少网络和内存的消耗。