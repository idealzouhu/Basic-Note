### 查询优化的思路

如果把查询看作一 个任务，那么它由一系列子任务组成，每个子任务都会消耗一定的时间。

那么，我们所能做的只要：

- 减少子任务的执行次数，消除不必要的子任务
- 让子任务运行的更快

为了实现这点，我们应该了解查询的生命周期和查询的时间消耗情况





### 慢查询基础：优化数据访问

性能很差的常见原因是访问数据过多。

对于低效的查询，我们发现通过下面两个步骤来分析总是很有效： 

1. 确认应用程序是否在检索大量且不必要的数据。这通常意味着访问了太多的行，但有时 候也可能是访问了太多的列。 
2. 确认MySQL服务器层是否在分析大量不需要的数据行。



#### 是否请求了不需要的数据

典型的案例有：

- 查询不需要的记录
- 查询不需要的列
- 重复查询相同的数据（可以考虑缓存）



#### MySQL 是否在扫描额外的记录

在确定查询只返回需要的数据以后，接下来应该看看查询为了返回结果是否扫描了过多的 数据。对于MySQL，最简单的衡量查询开销的三个指标如下： 

- 响应时间 ：服务时间 + 等待时间（IO等待 或者 锁）
- 扫描的行数 
- 返回的行数

这三个指标反映了 MySQL 在内部执行查询时需要访问多少数据，都会被记录到 MySQL 的慢日志中，所以**检查慢日志记录是找出扫描行数过多的查询的好办法**。





**响应时间**： 可以用 “快速上限估计” 来估算查询的响应时间。

**扫描的行数和返回的行数**： 理想情况下扫描的行数和返回的行数应该是相同的。但是，扫描的行数与返回的行数的比率通常很低，一般在1：1到10：1之间，不过有时候这个值也可能非常非常 大。

**扫描的行数和访问类型**： 在评估查询开销的时候，需要考虑从表中找到某一行数据的成本。EXPLAIN语句中的type列反映了访问类型。访问类型有很多种，从全表扫描到索引扫描、 范围扫描、唯一索引查询、常数引用等。这里列出的这些，速度从慢到快，扫描的行数从 多到少。你不需要记住这些访问类型，但需要明白扫描表、扫描索引、范围访问和单值访 问的概念。如果你没办法找到合适的访问类型，那么最好的解决办法通常就是增加一个合适的索引





### 怎么优化

如果扫描大量的数据但只返回少量的数据，可以尝试以下技巧：

- 使用索引覆盖扫描，把所有需要用的列都放到索引中，这样存储引擎无须回表获取 对应行就可以返回结果了
- 改变库表结构。例如，使用单独的汇总表
- 重写这个复杂的查询，让MySQL优化器能够以更优化的方式执行这个查询