# 一、三次握手

![image-20240313212956831](images/image-20240313212956831.png)

## 为什么要三次握手

三次握手最主要的目的就是双方确认自己与对方的发送与接收是正常的。

**第一次握手**：Client 什么都不能确认；Server 确认了对方发送正常，自己接收正常

**第二次握手**：Client 确认了：自己发送、接收正常，对方发送、接收正常；Server 确认了：对方发送正常，自己接收正常

**第三次握手**：Client 确认了：自己发送、接收正常，对方发送、接收正常；Server 确认了：自己发送、接收正常，对方发送、接收正常



更具体地来说：

第一次握手 + 第二次握手的 ACK =  建立并确认从客户端到服务端的通信 = 客户端发送正常 + 服务器接收正常

第二次握手的 SYN + 第三次握手 = 建立并确认从服务端到客户端的通信 = 服务端发送正常 + 客户端接收正常







三次握手的**首要原因是为了防止旧的重复连接初始化造成混乱**





### 为什么两次握手不行

在两次握手的情况下，服务端可能建立一个历史连接，造成资源浪费。服务端没有中间状态给客户端来阻止历史连接。







# 二、四次挥手

![image-20240313213131107](images/image-20240313213131107.png)

> 只要四次挥手没有结束，客户端和服务端就可以继续传输数据





个人理解，四次挥手跟三次握手的区别主要有：

- 在四次挥手里，服务器分两次发送ACK 、FIN； 在三次握手里面，服务器直接将一次性发送 SYN + ACK。具体来说，不能将服务器发送的 ACK 和 FIN 结合起来。

- 第四次挥手后，客户端需要等待 2 * MSL 时间。





## 为什么不能将服务器发送的 ACK 和 FIN 结合起来，变成三次挥手

> 因为收到客户端断开连接的请求时，服务器可能**还有一些数据没有发完**，这时先回复 ACK，表示接收到了断开连接的请求。等到数据发完之后再发 FIN，断开服务器到客户端的数据传送。





## 为什么客户端需要等待 2 * MSL 时间



**避免客户端发送给服务端的 ACK 丢失**

如果ACK 丢失，则会重新进行第三次挥手和第四次挥手。



# 参考资料

[TCP 三次握手和四次挥手（传输层） | JavaGuide](https://javaguide.cn/cs-basics/network/tcp-connection-and-disconnection.html#建立连接-tcp-三次握手)