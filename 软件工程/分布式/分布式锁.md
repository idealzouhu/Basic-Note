





 第一版 setnx： 向 Redis 中添加一个 lockKey 锁标志位，如果添加成功则能够继续向下执行扣减优惠券数量操作，最后再释放此标志位。

第二版 expire： 对 Redis 的 **锁标志位加上过期时间** 就能很好的防止死锁问题。 解锁操作放到 finally 块，但是还有存在死锁问题，**如果获得锁的线程在执行中，服务被强制停止或服务器宕机，锁依然不会得到释放**。

第三版 set：锁原子命令

第四版 verify value： 创建辨别客户端身份的唯一值，将加锁及解锁归一化。  解锁时， **由于判断锁和删除标志位并不是原子性的，所以可能还是会存在误删**

第五版 lua ： Redis 在 2.6 推出了脚本功能，允许开发者使用 Lua 语言编写脚本传到 Redis 中执行。



script 脚本就是我们在 Redis 中执行的 Lua 脚本，后面跟的两个 List 分别是 KEYS、ARGV。

```
cache.eval(script，Lists.newArrayList(lockKey)，Lists.newArrayList(lockValue));
```

- **KEYS[1]:** lockKey   // 锁标志位
- **ARGV[1]:** lockValue  // 客户端唯一标识





[从根上理解Redis分布式锁演进架构 (yuque.com)](https://www.yuque.com/magestack/12306/ag5pffwexihshe2s#9c537663)