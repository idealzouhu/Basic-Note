

## 运行时数据区域

**Java 虚拟机在执行 Java 程序的过程中会把它所管理的内存划分为若干个不同的数据区域**。这些区域有各自的用途，以及创建和销毁的时间，有的区域随着虚拟机进程的启动而一直存在，有些区域则是依赖用户线程的启动和结束而建立和销毁。

![Java 运行时数据区域（JDK1.8 ）](images/java-runtime-data-areas-jdk1.8.png)



### 程序计数器

程序计数器**存储了当前线程正在执行的指令的地址**，也就是下一条要执行的指令的位置。处理器在执行指令时会不断更新程序计数器，以便指向下一条将要执行的指令。

为什么程序计数器私有？通过将程序计数器设计为线程私有的，可以确保每个线程都能够独立地控制自己的执行流，而不受其他线程的干扰。



### Java 虚拟机栈

Java 虚拟机栈（Java Virtual Machine Stack）也描述的是 **Java 方法执行的线程内存模型**：每个方法被执行的时候，Java虚拟机都会同步创建一个栈帧（Stack Frame）用于存储局部变量表、操作数栈、动态连接、方法出口等信息。每一个方法被调用直至执行完毕的过程，就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。

在Java 虚拟机栈中， 局部变量表**只保存基础数据类型**和对象**引用**（它不等同于对象本身，对象是保存在堆区中的 ）



[《Java虚拟机规范》](https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-2.html#jvms-2.5.2) 规定 Java 虚拟机栈这个内存区域存在的两类异常情况：

- 如果线程请求的栈深度大于虚拟机所允许的深度，将抛出 StackOverflowError 异常

- 如果 Java 虚拟机栈容量可以动态扩展， 当栈扩展时无法申请到足够的内存会抛出 OutOfMemoryError异常



### **本地方法栈**

本地方法栈（Native Method Stack）的功能和 JVM 栈非常类似，区别在于虚拟机栈执行的是 Java 方法，本地方法栈执行的是本地（Native）方法服务，存储的也是本地方法的局部变量表，本地方法的操作数栈等信息。

> 在计算机编程中，"Native 方法"通常指的是以原生机器代码（通常是由C、C++或汇编语言编写）编写并由底层系统（如操作系统或硬件）直接支持的方法或函数。这些方法能够直接访问底层系统资源，并且在执行时不需要通过解释器或虚拟机进行额外的转换或解释。因此，Native 方法通常比通过解释器或虚拟机执行的方法更高效。



### Java堆

Java 堆（Java Heap）是在虚拟机启动时创建，存放对象实例。当Java**创建一个类的实例对象或者数组时，都会在堆中为新的对象分配内存**。值得注意的是，由于即时编译技术的进步，Java 对象实例都分配在堆上并不是那么绝对了

**Java 堆既可以被实现成固定大小的，也可以是可扩展的**，不过当前主流的Java虚拟机都是按照可扩展来实现的（通过参数-Xmx和-Xms设定）。如果在Java堆中没有内存完成实例分配，并且堆也无法再扩展时，Java虚拟机将会抛出 OutOfMemoryError 异常。





### 字符串常量池

**字符串常量池** 是 JVM 为了提升性能和减少内存消耗针对字符串（String 类）专门开辟的一块区域，主要目的是为了避免字符串的重复创建。





## 直接内存

**直接内存**（Direct Memory）是指不经过 Java 堆（Heap）而由操作系统管理的内存区域。这种内存分配通过 JNI（Java Native Interface）或 NIO（Java New I/O）等方式进行， 直接在操作系统的内存空间中船创建。

直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是《Java虚拟机规范》中 定义的内存区域。但是这部分内存也被频繁地使用，而且也可能导致 `OutOfMemoryError` 异常出现，

直接内存的分配总量由 JVM 参数 `-XX:MaxDirectMemorySize` 控制。如果分配超过了指定的最大直接内存大小或者物理内存限制(包括物理的和操作系统级的限制)，JVM 会抛出 `OutOfMemoryError`异常



### 方法区(元空间)

方法区（Method Area）用于存储已被虚拟机加载的类型信息、常量、静态变量、即时编译器编译后的代码缓存等数据。

方法区只是 [《Java虚拟机规范》](https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-2.html#jvms-2.5.4) 中的规范，其具体实现有：

- 永久代：Java 应用容易遇到内存溢出的问题
- 元空间：采用本地内存来实现方法区，只受本机可用内存的限制，降低内存溢出的概率



`Class` 对象本身存放在**元空间（Metaspace）**中， 用于存储类的元数据信息。



### 运行时常量池

运行时常量池（Runtime Constant Pool）是方法区的一部分。

Class 文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池表（Constant Pool Table），用于存放编译期生成的各种字面量与符号引用，这部分内容将在类加载后存放到方法区的运行时常量池中。





## 参考资料

《深入理解 Java 虚拟机  第三版》