## 一、分布式事务概述

### 1.1 什么是分布式事务

分布式事务（Distributed Transaction）是在分布式系统中，涉及多个独立数据源或服务的事务操作，以确保这些操作要么全部成功要么全部失败，从而保持数据的一致性和完整性。

事务应该具有4个属性：

1. **原子性（Atomicity）：** 事务是一个原子操作单元，要么全部执行成功（提交），要么全部失败（回滚），不会出现部分执行的情况。
2. **一致性（Consistency）：** 事务执行前后，数据库的状态应保持一致性，即事务执行成功后，数据库从一个一致性状态转换到另一个一致性状态。
3. **隔离性（Isolation）：** 多个事务并发执行时，每个事务的操作应该相互隔离，互不影响。一个事务的中间状态不应该被其他事务所见，直到该事务提交。
4. **持久性（Durability）：** 一旦事务提交，其结果应该永久保存在数据库中，即使系统故障或崩溃，也不应该丢失。





### 1.2 为什么引入分布式事务

单机事务简化了软件开发工程师的工作。事务使软件开发工程师不必再处理数据系统中所有可能出现的故障，不必再仔细斟酌各种意外情况，将这一系列责任从应用程序转移到了数据库，减轻了软件开发工程师的心智负担，减少了潜在的错误。

分布式事务不仅有单机事务中的好处，还隐藏了将数据分割在多台服务器上带来的故障处理等复杂问题。





## 二、怎么实现分布式事务

分布式事务的持久性和一致性基本上与单机事务类似。

相比之下，原子性和隔离性在分布式系统中的实现充满挑战。

>  另外，为了实习分布式事务，系统可能还需要一个全局的物理时钟(全局授时服务)



### 原子性的实现

不同于单机事务使用日志或者WAL技术来实现原子性， 分布式事务的原子性通过原子提交协议(Atomic Commit Protocol，ACP)来实现，原子提交协议也叫原子提交算法。原子提交协议必须满足以下三个特性：

- 协定性(Agreement)。所有进程都决议出同一个值,相当于所有进程要么一起提交事务，
  要么一起中止事务，不存在两个进程一个提交事务另一个中止事务的情况。
- 有效性(Validity)。如果所有进程都决定提交事务并且没有任何故障发生，那么最终个系统将提交事务;只要有一个进程决定中止事务，系统最终将中止事务。
- 终止性(Termination)。终止性又分为弱终止条件(Weak Termination Condition)和强终止条件(Strong Termination Condition)。弱终止条件是指，如果没有任何故障发生，那么所有进程最终都会做出决议(提交或终止事务):强终止条件也称为非阻塞条件(Non-Blocking Condition)，是指没有发生故障的进程最终会做出决议。

> 原子提交协议实际上解决了分布式共识问题的一个子类，即对事务的提交或中止达成共识。

常见的原子提交协议有：

- 两阶段提交(Two-Phase Commit，2PC)
- 三阶段提交
- Paxos 提交算法
- 基于 Qurrum 的提交算法



### 隔离性的实现

分布式事务是通过并发控制来实现隔离性。

并发控制是一种隔离并发事务以保证数据正确性的机制。不同的并发控制机制用来实现不同的隔离级别，并发控制机制主要分为以下几类：

- 悲观并发控制
- 乐观并发控制
- 多版本并发控制





## 注意事项

### ACID 的一致性和 CAP 定理中的一致性不一样

ACID 的一致性和 CAP 定理中的一致性是不一样的。

ACID 中的 C 属于数据库事务领域的概念，即数据库中的数据必须满足预定义的约束和完整性规则;

而 CAP 定理中的 C 指的是数据的线性一致性。