## 一、分布式事务概述

### 1.1 什么是分布式事务

分布式事务（Distributed Transaction）是在分布式系统中，<font color="red">**涉及多个独立数据源或服务的事务操作**</font>，以确保这些操作要么全部成功要么全部失败，从而保持数据的一致性和完整性。

分布式事务可以理解为单机事务的两种变体：

- **副本更新事务**：需要在多个数据副本上进行一致性更新。所有副本都必须成功提交事务，否则整体事务必须回滚，确保用户不会看到不一致的数据状态。
- **跨节点事务**：涉及跨越多个分区的数据操作。例如，在一个节点上减少用户A的账户余额，在另一个节点上增加用户B的账户余额。这样的事务需要跨多个节点，并且必须保证数据的一致性和事务的ACID属性。

通常，第一种变体大多数时候可以通过单主复制解决，而第二种变体是分布式事务中更常见和复杂的情况。



### 1.2 为什么引入分布式事务

单机事务简化了软件开发工程师的工作。事务使软件开发工程师不必再处理数据系统中所有可能出现的故障，不必再仔细斟酌各种意外情况，将这一系列责任从应用程序转移到了数据库，减轻了软件开发工程师的心智负担，减少了潜在的错误。

分布式事务不仅有单机事务中的好处，还隐藏了将数据分割在多台服务器上带来的故障处理等复杂问题。



### 1.3 分布式事务特性

分布式事务同样具备4个属性：

1. **原子性（Atomicity）：** 事务是一个原子操作单元，要么全部执行成功（提交），要么全部失败（回滚），不会出现部分执行的情况。
2. **一致性（Consistency）：** 事务执行前后，数据库的状态应保持一致性，即事务执行成功后，数据库从一个一致性状态转换到另一个一致性状态。
3. **隔离性（Isolation）：** 多个事务并发执行时，每个事务的操作应该相互隔离，互不影响。一个事务的中间状态不应该被其他事务所见，直到该事务提交。
4. **持久性（Durability）：** 一旦事务提交，其结果应该永久保存在数据库中，即使系统故障或崩溃，也不应该丢失。



## 二、怎么实现分布式事务

分布式事务的持久性和一致性基本上与单机事务类似。

相比之下，原子性和隔离性在分布式系统中的实现充满挑战。

>  另外，为了实习分布式事务，系统可能还需要一个全局的物理时钟(全局授时服务)



### 2.1 原子性的实现

**不同于单机事务使用日志或者 WAL 技术来实现原子性， 分布式事务的原子性通过原子提交协议(Atomic Commit Protocol，ACP)来实现**，原子提交协议也叫原子提交算法。原子提交协议必须满足以下三个特性：

- 协定性(Agreement)。所有进程都决议出同一个值,相当于所有进程要么一起提交事务，
  要么一起中止事务，不存在两个进程一个提交事务另一个中止事务的情况。
- 有效性(Validity)。如果所有进程都决定提交事务并且没有任何故障发生，那么最终个系统将提交事务;只要有一个进程决定中止事务，系统最终将中止事务。
- 终止性(Termination)。终止性又分为弱终止条件(Weak Termination Condition)和强终止条件(Strong Termination Condition)。弱终止条件是指，如果没有任何故障发生，那么所有进程最终都会做出决议(提交或终止事务):强终止条件也称为非阻塞条件(Non-Blocking Condition)，是指没有发生故障的进程最终会做出决议。

> 原子提交协议实际上解决了分布式共识问题的一个子类，即对事务的提交或中止达成共识。

常见的原子提交协议有：

- 两阶段提交(Two-Phase Commit，2PC)
- 三阶段提交
- Paxos 提交算法
- 基于 Qurrum 的提交算法



### 2.2 隔离性的实现

分布式事务是通过并发控制来实现隔离性。并发控制是一种隔离并发事务以保证数据正确性的机制。不同的并发控制机制用来实现不同的隔离级别，并发控制机制主要分为以下几类：

- **悲观并发控制**：使用锁来防止并发事务对数据的干扰，以实现串行化的隔离级别。事务在使用任何数据之前，**悲观**地认为会有事务争抢，于是需要先获取数据的锁。
- **乐观并发控制**：**乐观**地认为并发事务(尤其是并发写操作)是小概率事件，于是到事务结束时再检查事务是否正确。
- **多版本并发控制**：对每个数据项保存多个版本的数据，并保证每个事务的读操作读取到比该事务早的最后一次提交的数据。





### 2.3 一致性的实现

为了实现一致性(再次注意，这里指数据库层面的数据完整性)，系统可以在事务的前后引入一些额外的读写操作，以保证数据符合完整性约束，有时实现一致性不仅取决于数据库，还取决于应用程序的业务逻辑。

长久以来对 ACID 中的一致性是充满争议的，这是一个需要应用程序和数据库一起控制的属性，分布式事务通常不讨论ACID 中的一致性。





### 2.4 持久性的实现

想要实现持久性，<font color="red">只需在向客户端返回响应之前，确保将数据存储在非易失性存储设备中即可</font>，通常还会包括一些 WAL(Write-ahead Logging，中文为“预写式日志”或“预写日志”)或其他日志文件。虽然非易失性存储设备可能会损坏，但不考虑极端的情况(数据和备份全部损坏)，通过备份就可以解决该问题。

这里的总体解决思路和单节点事务没有太大差别。







## 注意事项

### ACID 的一致性和 CAP 定理中的一致性不一样

ACID 的一致性和 CAP 定理中的一致性是不一样的。

ACID 中的 C 属于数据库事务领域的概念，即数据库中的数据必须满足预定义的约束和完整性规则;

而 CAP 定理中的 C 指的是数据的线性一致性。





## 参考资料

《深入理解分布式系统  唐伟志》