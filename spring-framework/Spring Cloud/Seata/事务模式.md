## 一、AT 模式

### 前提

<font color="red">**基于支持本地 ACID 事务的关系型数据库**</font>。



### 整体机制

两阶段提交协议的演变：

- 一阶段：**业务数据和回滚日志**记录在同一个本地事务中提交，释放本地锁和连接资源。

- 二阶段：

  - 提交异步化，非常快速地完成。
  - 回滚通过一阶段的回滚日志进行**反向补偿**

  

### 写隔离

- <font color="red">一阶段本地事务提交前，需要确保先拿到 **全局锁** </font>。
- 拿不到 **全局锁** ，不能提交本地事务。
- 拿 **全局锁** 的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁。



### 读隔离

Seata（AT 模式）的默认全局隔离级别是 **读未提交（Read Uncommitted）** 。

如果应用在特定场景下，必需要求全局的 **读已提交** ，目前 Seata 的方式是通过 SELECT FOR UPDATE 语句的代理。



### 具体实施案例

[Seata AT 模式 | Apache Seata](https://seata.apache.org/zh-cn/docs/dev/mode/at-mode#一阶段)



## TCC 模式

根据两阶段行为模式的不同，我们将分支事务划分为 **Automatic (Branch) Transaction Mode** 和 **TCC (Branch) Transaction Mode**.

AT 模式基于 **支持本地 ACID 事务** 的 **关系型数据库**：

- 一阶段 prepare 行为：在本地事务中，一并提交业务数据更新和相应回滚日志记录。
- 二阶段 commit 行为：马上成功结束，**自动** 异步批量清理回滚日志。
- 二阶段 rollback 行为：通过回滚日志，**自动** 生成补偿操作，完成数据回滚。

相应的，TCC 模式，不依赖于底层数据资源的事务支持：

- 一阶段 prepare 行为：调用 **自定义** 的 prepare 逻辑。
- 二阶段 commit 行为：调用 **自定义** 的 commit 逻辑。
- 二阶段 rollback 行为：调用 **自定义** 的 rollback 逻辑。

所谓 TCC 模式，是指<font color="red">支持把 **自定义** 的分支事务纳入到全局事务的管理中</font>。 即 开发者显式定义 `Try`、`Confirm` 和 `Cancel` 三个操作，来控制分支事务的两阶段提交。





## SAGA 模式

Saga 模式是 SEATA 提供的长事务解决方案，在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。



## XA 模式

XA 模式基于 **支持 XA 事务** 的 **关系型数据库**



### 什么是 XA 模式

在 Seata 定义的分布式事务框架内，利用事务资源（数据库、消息服务等）对 XA 协议的支持，以 XA 协议的机制来管理分支事务的一种 事务模式。

猜测：这个分支事务应该类似于 Mysql 的内部 XA 事务。

![img](images/TB1hSpccIVl614jSZKPXXaGjpXa-1330-924.png)





## 不同模式之间的区别

| 特性         | AT 模式                | TCC 模式                   | Saga 模式               | XA 模式                |
|--------------|------------------------|----------------------------|-------------------------|------------------------|
| 执行模式     | 自动代理 JDBC 资源      | 业务逻辑的显式二阶段操作    | 长事务补偿机制           | 两阶段提交（2PC）       |
| 一致性保证   | 弱一致性              | 弱一致性                  | 最终一致性               | 强一致性               |
| 隔离性       | 基于全局锁隔离        | 基于资源预留隔离               | 无隔离                | 完全隔离               |
| 性能         | 较高                   | 较高                       | 较高                     | 较低                   |
| 应用场景     | 简单的分布式数据库事务 | 需要业务层显式编程的复杂场景 | 长时间运行的事务，允许部分步骤失败后补偿 | 需要强一致性和分布式数据库事务的场景 |







### 参考模式

[Seata AT 模式 | Apache Seata](https://seata.apache.org/zh-cn/docs/dev/mode/at-mode)